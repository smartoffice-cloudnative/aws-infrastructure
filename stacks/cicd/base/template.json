{
  "Resources": {
    "SourceCodeBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": "codepipeline-cf-source",
        "Tags": [
          {
            "Key": "Name",
            "Value": "Codepipeline SourceCode for CF"
          }
        ]
      }
    },
    "Pipeline": {
      "Type": "AWS::CodePipeline::Pipeline",
      "DependsOn" : "SourceCodeBucket",
      "Properties": {
        "ArtifactStore": {
          "Location": "codepipeline-cf-source",
          "Type": "S3"
        },
        "Name": "CfBasePipeline-dev",
        "RestartExecutionOnUpdate": false,
        "RoleArn": "arn:aws:iam::147376585776:role/codepipline-cloudformation-role",
        "Stages": [
          {
            "Name": "CheckoutSource",
            "Actions": [
              {
                "Name": "CheckoutSource",
                "ActionTypeId": {
                  "Category": "Source",
                  "Owner": "ThirdParty",
                  "Provider": "GitHub",
                  "Version": "1"
                },
                "Configuration": {
                  "Owner": "smartoffice-cloudnative",
                  "Repo": "aws-infrastructure",
                  "Branch": "master",
                  "PollForSourceChanges": "false",
                  "OAuthToken": "24a92bf067edab6065bf2cb8c085e556fa0d17bc"
                },
                "OutputArtifacts": [
                  {
                    "Name": "SourceArtifact"
                  }
                ],
                "RunOrder": 1
              }
            ]
          },
          {
            "Name": "DeployGeneralCfInfrastructure",
            "Actions": [
              {
                "Name": "CfVPC",
                "InputArtifacts": [
                  {
                    "Name": "SourceArtifact"
                  }
                ],
                "ActionTypeId": {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1"
                },
                "Configuration": {
                  "ActionMode": "CREATE_UPDATE",
                  "Capabilities": "CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND",
                  "RoleArn": "arn:aws:iam::147376585776:role/codepipeline-cf-vpcstack-role",
                  "StackName": "dev-vpc",
                  "TemplateConfiguration": "SourceArtifact::stacks/vpc/dev.json",
                  "TemplatePath": "SourceArtifact::stacks/vpc/template.yaml"
                },
                "RoleArn": "arn:aws:iam::147376585776:role/codepipline-cloudformation-role",
                "RunOrder": 1
              },
              {
                "Name": "CfEcsCluster",
                "InputArtifacts": [
                  {
                    "Name": "SourceArtifact"
                  }
                ],
                "ActionTypeId": {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1"
                },
                "Configuration": {
                  "ActionMode": "CREATE_UPDATE",
                  "Capabilities": "CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND",
                  "RoleArn": "arn:aws:iam::147376585776:role/codepipeline-cf-vpcstack-role",
                  "StackName": "dev-ecs-cluster",
                  "TemplatePath": "SourceArtifact::stacks/ecs-cluster/template.yaml"
                },
                "RoleArn": "arn:aws:iam::147376585776:role/codepipline-cloudformation-role",
                "RunOrder": 1
              },
              {
                "Name": "CfALB",
                "InputArtifacts": [
                  {
                    "Name": "SourceArtifact"
                  }
                ],
                "ActionTypeId": {
                  "Category": "Deploy",
                  "Owner": "AWS",
                  "Provider": "CloudFormation",
                  "Version": "1"
                },
                "Configuration": {
                  "ActionMode": "CREATE_UPDATE",
                  "Capabilities": "CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND",
                  "RoleArn": "arn:aws:iam::147376585776:role/codepipeline-cf-vpcstack-role",
                  "StackName": "dev-ecs-cluster",
                  "TemplatePath": "SourceArtifact::stacks/elb/template.yaml",
                  "TemplateConfiguration": "SourceArtifact::stacks/elb/dev.json"
                },
                "RoleArn": "arn:aws:iam::147376585776:role/codepipline-cloudformation-role",
                "RunOrder": 2
              }
            ]
          }
        ]
      }
    }
  }
}
